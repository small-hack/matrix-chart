{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:base"
  ],
  "forkProcessing": "enabled",
  "regexManagers": [
    {
      "description": "Update matrix docker image references",
      "fileMatch": ["^charts\\/matrix\\/Chart\\.yaml$"],
      "matchStrings": [
        "appVersion: '(?<currentValue>.*?)'\\s+",
        "version: '(?<currentValue>.*?)'\\s+"
      ],
      "depNameTemplate": "matrixdotorg/synapse",
      "datasourceTemplate": "docker"
    },
    {
      "description": "Update docker image references",
      "fileMatch": ["^charts\\/matrix\\/Chart\\.yaml$"],
      "matchStrings": ["image: (?<depName>.*?):(?<currentValue>.*?)\\s+"],
      "datasourceTemplate": "docker"
    }
  ],
  "packageRules": [
      {
        "matchManagers": ["helm-requirements", "helm-values", "regex"],
        "postUpgradeTasks": {
            "commands": [
                "version=$(grep '^version:' {{{parentDir}}}/Chart.yaml | awk '{print $2}')",
                "major=$(echo $version | cut -d. -f1)",
                "minor=$(echo $version | cut -d. -f2)",
                "patch=$(echo $version | cut -d. -f3)",
                "minor=$(expr $minor + 1)",
                'echo "Replacing $version with $major.$minor.$patch"',
                'sed -i "s/^version:.*/version: $\{major\}.$\{minor\}.$\{patch\}/g" {{{parentDir}}}/Chart.yaml',
                "cat {{{parentDir}}}/Chart.yaml",
              ],
          },
          "fileFilters": ["**/Chart.yaml"],
          "executionMode": "branch"
      }
  ]
}
